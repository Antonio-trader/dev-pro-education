
pipeline {
    agent none

    stages {
//         stage ('Install boto3') {
//         agent {
//             label 'Trinity'
//         }
//         steps {
//             sh 'pip3 install boto3'
//             sh 'pip3 install botocore'
//             sh 'ansible-galaxy collection install amazon.aws'
//             }
//         }

//         stage ('Install git') {
//         agent {
//             label 'Trinity'
//         }
//         steps {
//             sh 'apt install git -y'
//             }
//         }

        stage ('Pull git repo') {
        agent {
            label 'Trinity'
        }
        steps {
            sh 'cd /root/git_repo && git pull'
            }
        }

        stage ('decrypt secret_key.pem') {
        agent {
            label 'Trinity'
        }
        steps {
            sh 'cd /root/git_repo/HW_dev_pro/education_ansible && ansible-vault decrypt secret_key.pem --vault-password-file /tmp/test.txt || echo "The secret_key has already decrypted" '
//             sh 'cd /root/git_repo/HW_dev_pro/education_ansible && ansible-inventory -i aws_ec2.yml --list'
            }
        }

        stage ('terraform') {
        agent {
            label 'Trinity'
        }
        steps {
            sh 'cd /root/git_repo/HW_dev_pro/education_terraform/HW_terraform_code_without_modules && terraform apply -auto-approve'
            sh 'sleep 2m'
            }
        }

        stage ('Ansible') {
        agent {
            label 'Trinity'
        }
        steps {
            sh 'cd /root/git_repo/HW_dev_pro/education_ansible && ansible-playbook -i aws_ec2.yml play.yml'
            }
        }


    }
}